name: tests

on:
  push:
  pull_request:

jobs:
  docker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Start containers
        run: |
          docker compose up -d --build
          docker compose ps

      - name: Wait for DB + schema
        run: |
          # wait until we can list tables (schema loaded)
          for i in {1..90}; do
            if docker compose exec -T pg psql -U postgres -d postgres -c "select 1" >/dev/null 2>&1; then
              # if pagila DB exists, this will succeed; otherwise it will fail and keep waiting
              if docker compose exec -T pg psql -U postgres -d pagila -c "select 1" >/dev/null 2>&1; then
                echo "pagila is ready"
                break
              fi
            fi
            echo "waiting... ($i/90)"
            sleep 2
          done
          docker compose exec -T pg psql -U postgres -c "\l" || true
          docker compose exec -T pg psql -U postgres -d pagila -c "\dt" || true

      - name: Run tests (inside container)
        run: |
          docker compose exec -T pg chmod +x ./run_tests.sh
          docker compose exec -T pg ./run_tests.sh
